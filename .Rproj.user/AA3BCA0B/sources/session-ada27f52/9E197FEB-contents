#' Summarise taxa by metadata
#'
#' A quick dplyr function that allows to summarise (mean, median, sum, ...) all taxa for each category of a metadata column. So far tested only on discrete variables.
#'
#' @param physeq A \code{phyloseq} object
#' @param metadata_var A \code{character} with the name of the factor to summarise by. it must be accepted by the code{group_by} dplyr function
#' @param .fun a \code{function} object to call by the summarise function in dplyr. I am thinking \code{mean, median, sum, scale, ...}
#'
#' @return A \code{matrix} object with the metadata variable in columns, and taxa in rows
#' @export
#'
#' @examples
#'
#' data(enterotype)
#' matrix_for_plot <- phy_summarise_taxa_by_metadata(microbiome::transform(enterotype, "clr"), metadata_var = "Enterotype", .fun = mean)
#' pheatmap::pheatmap(matrix_for_plot)
#'
phy_summarise_taxa_by_metadata <- function(physeq, metadata_var, .fun = mean){

  taxNames <- taxa_names(physeq)

  physeq@sam_data[[metadata_var]] <- ifelse(is.na(physeq@sam_data[[metadata_var]]), "NA", physeq@sam_data[[metadata_var]])

  matrix.transformed <- phy_OtuMetaTable(physeq) %>%
    group_by(eval(parse(text = metadata_var))) %>%
    summarise_at(.vars = all_of(taxNames),.funs = .fun) %>%
    set_names(c(metadata_var, taxNames)) %>%
    column_to_rownames(metadata_var) %>%
    t()

  return(matrix.transformed)
}
